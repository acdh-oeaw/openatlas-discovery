<script lang="ts" setup>
import { keyByToMap } from "@acdh-oeaw/lib";
import type { Geometry } from "geojson";
import { z } from "zod";

import { hasCoordinates } from "@/utils/has-geojson-coordinates";

// defineRouteRules({
// 	prerender: true,
// });

definePageMeta({
	title: "EntityPage.meta.title",
	middleware: "database-check",
	validate(route) {
		const paramsSchema = z.object({
			id: z.coerce.number().int().positive(),
		});
		return paramsSchema.safeParse(route.params).success;
	},
});

const t = useTranslations();

const route = useRoute();
const id = computed(() => {
	return Number(route.params.id as string);
});

const { data, isPending, isPlaceholderData } = useGetEntity(
	computed(() => {
		return { entityId: id.value };
	}),
);

const isLoading = computed(() => {
	return isPending.value || isPlaceholderData.value;
});

const entity = computed(() => {
	return data.value;
});

const entities = computed(() => {
	return data.value ? [data.value] : [];
});

useHead({
	title: computed(() => {
		return entity.value?.title ?? t("EntityPage.meta.title");
	}),
	// TODO: description, other metadata
});

const tabs = computed(() => {
	const tabs = [];
	if (
		entity.value?.geometries != null &&
		hasCoordinates(entity.value.geometries as unknown as Geometry)
	) {
		tabs.push({
			id: "geo-map",
			label: t("EntityPage.map"),
		});
	}
	if (entity.value?.files != null) {
		tabs.push({
			id: "images",
			label: t("EntityPage.images", { count: entity.value.files.length }),
		});
	}
	return tabs;
});

const relationsByType = computed(() => {
	return new Map(Object.entries(entity.value?.relations ?? {}));
	// return groupByToMap(entity.value?.relations ?? [], (relation) => {
	// 	// FIXME: This used to use `relationType` (without the prefix)

	// 	return relation.relationSystemClass;
	// });
});

const typesById = computed(() => {
	return keyByToMap(
		entity.value?.types?.filter((type) => {
			return type != null;
		}) ?? [],
		(type) => {
			return type.id;
		},
	);
});
</script>

<template>
	<MainContent class="container relative grid grid-rows-[auto_1fr] gap-4 py-8">
		<template v-if="entity != null">
			<Card>
				<CardHeader>
					<EntitySystemClass :system-class="entity.systemClass" />
					<PageTitle>{{ entity.title }}</PageTitle>
				</CardHeader>
				<CardContent>
					<div class="grid gap-4">
						<EntityTimespans v-if="entity.when" :timespans="[entity.when]" />
						<EntityDescriptions :descriptions="[entity?.description ?? '']" />
						<!-- Types -->
						<div class="flex flex-row flex-wrap gap-1">
							<TypesPopover
								v-for="type in entity.types"
								:key="type?.id ?? type?.title ?? 'missing'"
								:type="type"
							/>
						</div>
					</div>
				</CardContent>
			</Card>

			<Tabs v-if="tabs.length > 0" :default-value="tabs[0]?.id">
				<TabsList>
					<TabsTrigger v-for="tab of tabs" :key="tab.id" :value="tab.id">
						{{ tab.label }}
					</TabsTrigger>
				</TabsList>
				<!-- TODO: keep map alive -->
				<TabsContent v-for="tab of tabs" :key="tab.id" :value="tab.id">
					<EntityGeoMap v-if="tab.id === 'geo-map'" :entities="entities" />
					<EntityImages
						v-else-if="tab.id === 'images' && entity.files && entity.files?.length > 0"
						:images="entity.files"
					/>
				</TabsContent>
			</Tabs>

			<Card>
				<CardHeader>
					<CardTitle>{{ t("EntityPage.details") }}</CardTitle>
				</CardHeader>
				<CardContent>
					<dl
						class="grid gap-x-8 gap-y-4 sm:grid-cols-[repeat(auto-fill,minmax(20rem,1fr))] sm:justify-start"
					>
						<div v-for="[relationType, relations] of relationsByType" :key="relationType">
							<dt class="text-xs font-medium uppercase tracking-wider text-muted-foreground">
								{{ t(`SystemClassNames.${relationType}`) }}
							</dt>
							<dd>
								<ul role="list">
									<li v-for="(relation, index) of relations.slice(0, 10)" :key="index">
										<NavLink
											v-if="relation?.id"
											class="underline decoration-dotted hover:no-underline"
											:href="{
												path: `/visualization/`,
												query: {
													mode: 'table',
													selection: relation.id,
												},
											}"
										>
											{{ relation.title }}
										</NavLink>
										<span v-if="relation?.systemClass === 'type' && typesById.has(relation.id)">
											({{
												typesById
													.get(relation.id)
													?.typeHierarchy?.map((h) => h.label)
													.join(" > ")
											}})
										</span>
									</li>
								</ul>
								<details v-if="relations.length > 10">
									<summary class="cursor-pointer py-1 text-sm text-muted-foreground">
										{{ t("Global.ShowMore") }}
									</summary>
									<ul role="list">
										<li v-for="(relation, index) of relations.slice(10)" :key="index">
											<NavLink
												v-if="relation?.id"
												class="underline decoration-dotted hover:no-underline"
												:href="{
													path: `/visualization/`,
													query: {
														mode: 'table',
														selection: relation.id,
													},
												}"
											>
												{{ relation.title }}
											</NavLink>
											<span v-if="relation?.systemClass === 'type' && typesById.has(relation.id)">
												({{
													typesById
														.get(relation.id)
														?.typeHierarchy?.map((h) => h.label)
														.join(" > ")
												}})
											</span>
										</li>
									</ul>
								</details>
							</dd>
						</div>
					</dl>
				</CardContent>
			</Card>
		</template>

		<template v-else-if="isLoading">
			<Centered class="pointer-events-none opacity-50">
				<LoadingIndicator />
			</Centered>
		</template>
	</MainContent>
</template>
